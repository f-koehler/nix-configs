---
name: "CI"
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
jobs:
  build:
    name: "Nix: ${{matrix.flakeref}}"
    strategy:
      fail-fast: false
      matrix:
        flakeref:
          - ".#nixosConfigurations.homeserver.config.system.build.toplevel"
          - ".#nixosConfigurations.fkt14.config.system.build.toplevel"
          - ".#nixosConfigurations.desktop.config.system.build.toplevel"
          - ".#homeConfigurations.fkoehler@homeserver.activationPackage"
          - ".#homeConfigurations.fkoehler@fkt14.activationPackage"
          - ".#homeConfigurations.fkoehler@desktop.activationPackage"
          - ".#homeConfigurations.fkoehler@desktop-ubuntu.activationPackage"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: wimpysworld/nothing-but-nix@main
        with:
          hatchet-protocol: rampage
      - uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            lazy-trees = true
      # - name: Configure secrets
      #   run: nix develop --no-pure-eval --command ./testing/configure-secrets.py
      - run: nix run ".#prepare-test-secrets"
      - run: nix build ${{ matrix.flakeref }} -L
